name: Retrieval PyTorch Tests for Target Determination

on:
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}-${{ github.event_name == 'workflow_dispatch' }}-${{ github.event_name == 'schedule' }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  index:
    runs-on: linux.g5.4xlarge.nvidia.gpu
    environment: target-determinator-env
    steps:
      - name: Clone PyTorch
        uses: actions/checkout@v3
        with:
          repository: pytorch/pytorch
          fetch-depth: 0
          path: pytorch

      - name: Clone CodeLlama
        uses: actions/checkout@v3
        with:
          repository: osalpekar/codellama
          ref: main
          path: codellama

      - name: Clone Target Determination Code
        uses: actions/checkout@v3
        with:
          repository: clee2000/llm-target-determinator
          ref: csl/testing
          path: llm-target-determinator

      - name: Setup Conda
        uses: conda-incubator/setup-miniconda@v2.1.1
        with:
          miniconda-version: "py39_4.12.0"
          python-version: 3.9

      - name: Install Requirements
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          conda create \
            --yes \
            --quiet \
            --name "tdenv" \
            "python=3.9"
          conda activate tdenv
          pip install awscli==1.29.40
          cd "${GITHUB_WORKSPACE}/llm-target-determinator"
          pip install -r requirements.txt
          cd ../codellama
          pip install -e .

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::308535385114:role/gha_target_determinator_s3_read_write
          aws-region: us-east-1

      - name: Fetch CodeLlama Checkpoint
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          conda activate tdenv
          cd codellama/
          mkdir "CodeLlama-7b-Python"
          aws s3 cp "s3://target-determinator-assets/CodeLlama-7b-Python" "CodeLlama-7b-Python" --recursive

      - name: Fetch indexes
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          conda activate tdenv
          cd "${GITHUB_WORKSPACE}"/llm-target-determinator
          aws s3 cp "s3://target-determinator-assets/indexes/indexer-functions.zip" "indexer-functions.zip" --recursive
          unzip indexer-functions.zip -d assets/indexer-functions
          aws s3 cp "s3://target-determinator-assets/indexes/indexer-files.zip "indexer-files.zip" --recursive
          unzip indexer-functions.zip -d assets/indexer-files
          ls assets
          ls assets/indexer-files

      - name: Run Retriever
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          conda activate tdenv
          cd "${GITHUB_WORKSPACE}"/llm-target-determinator
          torchrun \
            --standalone \
            --nnodes=1 \
            --nproc-per-node=1 \
            retriever.py \
            --experiment-name indexer-files \
            --git-diff

          torchrun \
            --standalone \
            --nnodes=1 \
            --nproc-per-node=1 \
            retriever.py \
            --experiment-name indexer-files \
            --changed-files

          torchrun \
            --standalone \
            --nnodes=1 \
            --nproc-per-node=1 \
            retriever.py \
            --experiment-name indexer-functions \
            --git-diff

          torchrun \
            --standalone \
            --nnodes=1 \
            --nproc-per-node=1 \
            retriever.py \
            --experiment-name indexer-functions \
            --changed-files
